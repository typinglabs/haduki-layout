# 活動ログ

## 日付

### 2025-12-13


ビームサーチの実装が完了。とりあえず幅10、3-gram 3000個で探索してみる。まだ貪欲よりかなりスコアが低い。というかメジャーかな（か、と等）が単打に配置されていないのでそこを先に直した方がよいかも。

```
いたうんてのらっなま
しゃゅこをあくょ゛る
もそめわほはきーれえ

ね　ぬへ　　　　　　
　　　　ふ　　　　　
む　　　　　　　　　

す　や　　つせかと　
　　　ゆ　けお　　　
ろ　　　　　　　よさ

　に　。　　　　　み
　　　、　　　　　り
　　ひ　　　　ち　　

{
  "score": 582538,
  "kpm": 776.74,
  "totalSeconds": 112712001,
  "totalCount": 1094317502
}
```

3-gramの個数やビーム幅を広げて実行してみる。3-gram全部読み込んでも動いたのでそうすることに。貪欲にはまだ届いていない。

```
$ bun run src/cli.ts search
かういんるえけはされ
のゃゅたをまくょ゛つ
わふーろむてっらもあ

　　す　　　　　　　
　　　　　　　　　　
　　ほ　　　　へそこ

　　め　　せね　よ　
　　　や　　　　　な
　　　　　ぬと　おゆ

み　　き　　　　　ち
し　　、　りに。　　
ひ　　　　　　　　　

{
  "score": 629832,
  "kpm": 820.21,
  "totalSeconds": 104248461,
  "totalCount": 1094317502
}
```

次はビーム幅を広げる。幅100に広げた。結構時間かかったのでこれ以上は難しいか。スコアは弱体化している。

```
$ bun run src/cli.ts search
むやらーぬのけくまも
おゃゅをわろさょ゛は
かういんるめえれてっ

　へね　ゆよ　　と　
　　　そ　　　　　　
　　ほ　　　　ふ　　

　　　　　せなあ　つ
　　　　　す　　　　
　　　　　こた　　　

ひ　　　　　　　　　
　　　　ち　に、　。
み　　きり　　　　し

{
  "score": 592930,
  "kpm": 797.13,
  "totalSeconds": 110736657,
  "totalCount": 1094317502
}
```

やっぱり、頻度TOP26を単打に配置するように変更してみる。

---

いったん高速化は置いておいて、ビームサーチでいい配置を見つけられるかどうかやってみる。

trigram9万個は重いので、3000個くらいだけ見るように変更。これなら割と速くできる。スコアも全部見て計算した時より良くなってるかも。

```
$ bun run src/cli.ts search
んかのいれすせたこさ
るゃゅーあにとょ゛し
りなっらうくてつきは

　めぬへふ　　　　　
わ　　　ほ　ね　　　
　ま　お　　　む　　

　もを　　ゆ　　よ　
ろ　　　　　　　　　
　けそ　　えや　　　

ち　　　　　。み　　
　　　ひ　　　、　　
　　　　　　　　　　

{
  "score": 646363,
  "kpm": 824.85,
  "totalSeconds": 101582317,
  "totalCount": 1094317502
}
```

### 2025-12-11

書き忘れていた。やっと配列の探索第一弾が完成した。初手は貪欲法で実装。

力尽きたので一旦ここでマージして勉強に戻る。ここから改善を積み重ねて理想に近づけていく。今日見つかった配列は以下。拗音になる「ひ」が「ゅ」と同じ位置にあり、バリデーションは通しているので不備があるみたいだ。また明日修正する。

```
$ bun run src/cli.ts search
んいのてさなせとりっ
すゃゅるはこうょ゛た
つあーにらかくれきし

むやへぬ　ほ　　　　
よ　　け　　　　　　
もねふ　　　　　　　

そゆ　　　　　　　　
　　　　　えま　　め
ろわ　　　をお　　　

、　。　　　　　　ち
　　ひ　み　　　　　
　　　　　　　　　　
```

配列をJSONで出力して打鍵効率を評価してみた。

```
$ bun run src/cli.ts keystrokes
{
  "totalKana": 1190182,
  "keystrokesWithoutShift": 1496399,
  "keystrokesWithShift": 1574516,
  "efficiencyKanaPerKeystrokeWithoutShift": 1.2572858604818422,
  "efficiencyKanaPerKeystrokeWithShift": 1.3229203600793829
}
```

データセットが違うのもあり、打鍵効率は最高より2%程度低い。これは単打に配置するかなで決まっているので探索の良し悪しはここからは分からない。

続いて打鍵時間の推測。だいたい800kpmくらいが出る計算になっている。

```
$ bun run src/cli.ts stroke-time < words/e-typing-issunbousi.txt
{
  "totalMs": 10049.916275399128,
  "totalMsByTrigram": 10049.916275399128,
  "strokes": 134,
  "kanaCount": 100,
  "efficiency": 1.34,
  "kpm": 800.0066647003679,
  "strokeString": "qkhrlmk/lwtqgwpaqylj/vrdwglorln;ynkzmprwdojk/;Emkglxtqgmkxkqnkjnelrcdxdnkzmprwdojk/;ErlgwprjkwojkaEwpaqylj/gGwdhedicdxdrlrlnfdrw.jk/;E"
}
haduki-layout on  stroke-time-heuristic [!⇡] via 🥟 v1.2.17
$ bun run src/cli.ts stroke-time < words/e-typing-sarukani.txt
{
  "totalMs": 7842.633001209263,
  "totalMsByTrigram": 7842.633001209262,
  "strokes": 107,
  "kanaCount": 85,
  "efficiency": 1.2588235294117647,
  "kpm": 818.6026298833688,
  "strokeString": "gwdm;knk;lun.e;xdQ;ltywigtGrlyd/lmfqlEnvnlwjitp.jkw;n.e;xdnb;knlrlr.rGfGfjPvmlqmlqmkmk.myo;mtqen.nlGeojk/;E"
}
haduki-layout on  stroke-time-heuristic [!⇡] via 🥟 v1.2.17
$ bun run src/cli.ts stroke-time < words/e-typing-kaguyahime.txt
{
  "totalMs": 10117.737394195108,
  "totalMsByTrigram": 10117.737394195108,
  "strokes": 138,
  "kanaCount": 101,
  "efficiency": 1.3663366336633664,
  "kpm": 818.3647862565122,
  "strokeString": "mk/lwtqnl;fdwdclrlxdzdinlDnprwfcd/.ly;fdnkGzfdjk/;Emk/lwtqnlqke;fdnk.prGfiynvqk,gnxkwb/wmkqyehnlw;erlaEqkehnknmlwdD;kiyzlfd;wuzvqk;lrjk/;E"
}
haduki-layout on  stroke-time-heuristic [!⇡] via 🥟 v1.2.17
$ bun run src/cli.ts stroke-time < words/e-typing-momotarou.txt
{
  "totalMs": 9513.405611452123,
  "totalMsByTrigram": 9513.40561145212,
  "strokes": 125,
  "kanaCount": 97,
  "efficiency": 1.288659793814433,
  "kpm": 788.3612143028561,
  "strokeString": "mkglxtqnlnxkrluq;mnk/rwfimkmk.yzdzdnlynl,r.jk/;Emkglxtqgdlpmo/rzdzdnkwhkvzdPnhko.prGfiQyqiynnbflq.ymkihexnpsqnlidl;l/r.;erlaE"
}
haduki-layout on  stroke-time-heuristic [!⇡] via 🥟 v1.2.17
$ bun run src/cli.ts stroke-time < words/e-typing-omusubi.txt
{
  "totalMs": 8178.052404452221,
  "totalMsByTrigram": 8178.052404452221,
  "strokes": 109,
  "kanaCount": 86,
  "efficiency": 1.2674418604651163,
  "kpm": 799.7014052440594,
  "strokeString": "mk/lwtqnlmkwnfdrwmimkqdadlghzkhzkhzknlprQxyvmkPr/jkp;erlaEafixyeynnbQmkqdadlhzkoqapiqiqQiadj.yj;nl.hhkr.jk/;E"
}
```

### 2025-12-08

引き続き打鍵効率を最小化する配列を作成する関数を実装していく。なんでも想像しているより時間がかかるものだなぁ。30分で片付けようと思ったものが70分かかり、さらに間違いも残っている。

実装の間違いに気づくことができるのは配列のバリデーションがあるからなので、実装しておいて良かったなと思った。

```
$ bun run src/cli.ts keystrokes
たゅをっつきさうすお
といもてくになはあゃ
しまこょのらるか゛ん

む　　ほね　　やよそ
れけ　　ろ　ふ　　　
　　　　　ーへ　　　

　　せ　　　　　　め
ゆ　　　　　　　わ　
　　　　　え　ぬ　　

　　　　　　　　。　
　　み　　　　、　　
　ひ　　り　　　　ち

{
  "totalKana": 1190182,
  "keystrokesWithoutShift": 1465026,
  "keystrokesWithShift": 1558456,
  "efficiencyKanaPerKeystrokeWithoutShift": 1.2309260264396538,
  "efficiencyKanaPerKeystrokeWithShift": 1.3094266255076954
}
```

条件を満たしつつ、打鍵効率が最小になるような配列をランダムに生成することができるようになった。手でやるのは簡単なんだけど実装するのはかなり大変だった...。ただこれで量産できるようになったので時間をかけた価値はあっただろう。

### 2025-12-07

```text
// STEP1. シフトキーを配置する
// STEP2. 濁音になる21かなと、濁音にならない拗音の3かな（にみり）を排他的に配置する
// 単打ではない拗音は、通常シフトに配置する
// は、は単打でなければならないので、top26に入っているか確認する
// ふへほは、マイナーかなの場合はゅ後置シフトに配置する
// それ以外の単打ではないかなは、ゅ後置でもょ後置でもいいので、ランダムに配置する
// STEP3. 通常シフトに関するかなを配置する（母音と句読点）
// 外来音になる"ふてうとしちつ"は濁音ですでに配置済みなので、これと位置が被らないように注意しながら配置する
// 母音はシフトキーとふてうとしちつ、拗音が配置されている場所には置けない。
// 句読点は少し条件が違って後置シフトを占有しないので、母音が置けない場所のうち、ょゅシフトと、メジャー拗音には置
```

- シフトキーに関するルール
  - [x] 後置シフトキーの後置にかなを配置しない（ひとまず。ローマ字テーブルがややこしくなるため）→後置シフトに置
  - [x] 濁点シフトキー（゛ゃ）の通常シフトにはかなを配置しない（濁音の外来音をシフト押しっぱで打てるようにする
- 拗音に関するルール
  - [x] 拗音になるかなは排他的に配置する→拗音を同時におくので満たされる
  - [x] 拗音になるかなの後置シフトにかなを配置しない（配置したかなが打てないので）→後置するときに除外する
  - [x] 拗音になるかなが単打ではない場合は、拗音になるかなは通常シフトに入れる（後置シフトは拗音になるので）→拗リストを参照して決める
- 濁音に関するルール
  - [x] 濁音になるかなは排他的に配置する→濁音を同時におくので満たされる
- 半濁音に関するルール
  - [x] は は単打で、かつ後置シフトにかなを配置しない（は+ゅ、は+ょに半濁点を割り当てるため）→単打のリストにある
きに拗音と同様に除外する。
  - [x] ふへほのの ょ後置シフトにかなを配置しない（ょは半濁点シフトに使うため）→特殊なルールなので要注意。
  - [x] ふへほが単打ではない場合は、ゅ後置シフトに配置しなければならない（ょは半濁点シフトに使うため）→配置する
- 外来音に関するルール
  - [x] 外来音になるかなは排他的に配置する（あいうえおふてうとしつ）→あいうえお句読点を配置するときにふてうとし
  - [x] 外来音になるかなが後置シフトにある場合は、通常シフトにかなを配置してはならない（通常シフトで打てるように→置くかなを同時に決めればOK。
- その他
  - [x] 句読点は通常シフトに配置する（タイピングゲームで使わず、JISかなや薙刀式でも2打のため）→母音と同時に配置
  - 長音は単打に配置したい（2打だとタイピングゲームで意外と困るため）→TODO
  - 拗音で、デュとかテュとかフュとか、イ段意外の後ろにつくやつもあるからそれも考慮したい→TODO


---

打鍵効率の最小化について、濁音や拗音の打鍵数はルールに従っていれば同じだから、これらを除いた数を最小化するように配置すればOK。これは頻度が多いものから順に単打に配置すれば達成できる。

なので、1~26位（30キー-シフト4つ）を単打に配置しつつ、ルールを満たすようなレイアウトを作ればよい。どうするか手順を考えてみる。

- シフト4つを適当な位置に配置する。ょ、ゅの通常シフトに句読点を置くことはできるが、それ以外はNG。
- 濁音になる21かなと、濁音にならない拗音3かな（にみり）の24かなを、シフトキー以外の位置に配置する。
  - これは頻度を見れば単打かシフトか決められる。
- 母音と、外来音になるかな（ふてうとしちつ）、句読点を配置する。外来音になるかなは配置済みか。
  - 拗音になるかなが配置されている場所には置けないことに注意する。
- 残りのかなを配置する。これらのかなには条件がないので、他のかなの条件を壊さないように配置する。

---

Codexに暴れてもらったが、それを飲み込むより自分で手を動かしながらやる方が理解が進むのでそうする。分かったことをメモにまとめてもらう。

```text
- 山登り法では局所解にハマりやすく、頻度の高いかなを単打へ十分に寄せ切れないまま止まりがちだった。
- 焼きなまし法に変え、頻度を重みとした水平/垂直スワップ近傍を採用したことで、悪化解も確率的に受理でき、打鍵効率（打鍵数/かな
  数）が改善する解に到達しやすくなった。
- 近傍は「かなが入っているスロット同士のスワップ」に限定しており、レイアウトの不完全化（かな欠落）が起きないようにしている。
- 通常シフトには拗音（単打でない）と句読点以外を置かない制約を入れ、ローマ字テーブル・ストローク計算のルールと整合を取った。
```

実装に進む前に、配列が満たすべき条件を改めてまとめてみる。テストに書いているのでそこから抜き出す。

- シフトキーに関するルール
  - 後置シフトキーの後置にかなを配置しない（ひとまず。ローマ字テーブルがややこしくなるため）
  - 濁点シフトキー（゛ゃ）の通常シフトにはかなを配置しない（濁音の外来音をシフト押しっぱで打てるようにするため）
- 拗音に関するルール
  - 拗音になるかなは排他的に配置する
  - 拗音になるかなの後置シフトにかなを配置しない（配置したかなが打てないので）
  - 拗音になるかなが単打ではない場合は、拗音になるかなは通常シフトに入れる（後置シフトは拗音になるので）
- 濁音に関するルール
  - 濁音になるかなは排他的に配置する
- 半濁音に関するルール
  - は は単打で、かつ後置シフトにかなを配置しない（は+ゅ、は+ょに半濁点を割り当てるため）
  - ふへほのの ょ後置シフトにかなを配置しない（ょは半濁点シフトに使うため）
  - ふへほが単打ではない場合は、ゅ後置シフトに配置しなければならない（ょは半濁点シフトに使うため）
- 外来音に関するルール
  - まだ実装してなかった！まずい
  - 外来音になるかなは排他的に配置する（あいうえおふてうとしつ）
  - 外来音になるかなが後置シフトにある場合は、通常シフトにかなを配置してはならない（通常シフトで打てるようにしたいため）
- その他
  - 句読点は通常シフトに配置する（タイピングゲームで使わず、JISかなや薙刀式でも2打のため）
  - 長音は単打に配置したい（2打だとタイピングゲームで意外と困るため）
  - 拗音で、デュとかテュとかフュとか、イ段意外の後ろにつくやつもあるからそれも考慮したい

結構ある...。

### 2025-12-06

打鍵効率を最小化するヒューリスティックを書く準備をする。準備する必要があるのは、データセット、文字をストロークに変換する関数、打鍵効率を計算する関数。あと、最初にランダム生成するものが条件を満たしていないのでそこも探索を書くときに修正したい。

データセットについて、まずはkouyさんが公開されている100万字のかなのn-gramのデータを使用させていただくことにする。必要なのは1gramというか拗音と外来音は2gramで欲しくて、1gramからそれを除外したやつ。これは打鍵数のヒートマップを作った時にデータがあった気がするので、それと同じようなデータを使えばよい。

[100万字日本語かなn-gramデータ : ローマ字入力でもなく、かな入力でもなく](https://kouy.exblog.jp/9731073/)

[1万字のかなを入力する場合の打鍵数 : ローマ字入力でもなく、かな入力でもなく](https://kouy.exblog.jp/7888078/)

1万字のかなを入力する場合の打鍵数のシートkeycount.odsから、拗音や外来音を別でカウントしたO行のデータをコピーしてきた。

---

制約をちゃんとコードに落とし込んでおいた方が後々良さそうなので、バリデーションの処理を書いておく。拗音の排他、濁音の排他、外来音の排他、シフトキーにの後置には配置しない、等色々ルールがある。半濁音に関するルールも増えたのでそれも実装する。

以下のレイアウトのローマ字テーブルを作成して、動作確認した。

![2025/12/06のレイアウト](./images/2025-12-06-layout.png)

---

仕様に変えたい部分があるのでランダム生成処理の書き換えやローマ字テーブルの修正を行って確認する。ま行+濁点=ぱ行をやめて、は行+半濁点=ぱ行にしたい。頻度の少ないパ行のために単打を1つ潰すのはいただけないので、は行のマイナーかなは"ゅ"後置シフトに配置して、"ょ"後置シフトを半濁音にするなどして同置を達成したい。つまり、"ょ"キーが半濁点を兼用するということ。

こうすると"ぴ"が打てなくなるので、ここだけは+ゅ=ぴ、みたいな例外を作る。一旦これでローマ字テーブルを実装して、ちゃんと打てるか確認してみよう。

修正してテストを実行すると落ちて、これはもっと前の修正から落ちてたっぽい。CIの必要性を感じたので設定しておきたい。

### 2025-12-05

昨日に引き続きローマ字テーブルエクスポートの処理を書いている。Codexを使うためにChatGPTProを契約した。bunの正しいセットアップと、テストを色々書いてもらっている。テスト大事、遠回りは近道。

### 2025-12-04

ローマ字テーブルにエクスポートする処理を書いている。テストを書きながらやった方が良さそうな気はするが、bunのテストの書き方しらないので面倒だ。Copilotを使っていて、コード生成より補完の方が自分で書いてある感じが好きだったのだが、利用制限に達してしまった。Proプラン（$10）に加入するか悩ましい。Codexも使ってみたいなと思っている。とりあえず腕力で書き上げることにして、中期的（アドカレ〆切が2週間後くらいなので、1週間単位くらい）な効率も考えつつ進めたい。

### 2025-12-03

配列の探索をする前に、条件を満たす配列をランダムに生成するプログラムを作成してみる。

---

ゃゅょに後置シフトのキーを配置するとローマ字テーブルがややこしくなることが分かった（月見草と同じ）ので、シンプルさを優先するためにとりあえずやめることにした。

濁音が26キーで、シフトキーが4つなので濁音になるかながピッタリはまる。ただ「に」「り」に配置した濁音になるかなは後置シフトではなく、通常シフトで入力しなければならなくなってしまった。

ヒートマップを見ながら配置をある程度調整したので、ローマ字テーブルを作成して実際に打ってみよう。

![ヒートマップ](./images/2025-12-03-heatmap.png)

ローマ字テーブルが完成した。まぁまぁシンプルにできた気がする。長音を中段に配置したくて、そうしようとすると`/`と`'`って同じくらいの打ちやすさというか手を下げなくても良い分`'`の方が若干打ちやすいので、32キーにするかは悩んでいる。そうするとシフトでしか押せないキーがマイナー拗音ちひみだけになるので、そうした方がいい気がする。

### 2025-12-02

アドカレに投稿することも考えて、ログを残しつつ2週間で配列を作ろうと思った。

作成する配列は「清濁同置、拗音同置、外来音同置」の月配列。月見草配列、月林檎配列、薙刀式などに影響を受けている。

ひとまず草案を作ってコンセプトは大まかに実現できることは分かったので、あとは配置を煮詰めていきたい。

やりたいことは、

- [x] 打鍵時間を見積もるモデルを作成する→最近やってて大体できた
- [ ] 配列の評価ができるようにする（kouyさんのデータをお借りする予定）
- [ ] ヒューリスティック探索について学ぶ→問題に対する効果的な向き合い方を習得したい

明日は条件を満たす配列をランダムに生成してみようと思う。そして近傍を作って、ひとまずは評価方法を打鍵効率にして探索がちゃんとできることを確認したい。そこまでやるのに3日くらいかかりそうな気配はある。また明日。
